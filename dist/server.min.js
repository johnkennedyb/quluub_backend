const express=require("express"),http=require("http"),{Server:Server}=require("socket.io"),dotenv=require("dotenv"),jwt=require("jsonwebtoken"),connectDB=require("./config/db"),{notFound:notFound,errorHandler:errorHandler}=require("./middlewares/errorHandler_fixed"),adminRoutes=require("./routes/adminRoutes"),authRoutes=require("./routes/authRoutes"),chatRoutes=require("./routes/chatRoutes"),emailRoutes=require("./routes/emailRoutes"),matchNotificationRoutes=require("./routes/matchNotificationRoutes"),notificationRoutes=require("./routes/notificationRoutes"),paymentRoutes=require("./routes/paymentRoutes"),referralRoutes=require("./routes/referralRoutes"),relationshipRoutes=require("./routes/relationshipRoutes"),reportRoutes=require("./routes/reportRoutes"),userRoutes=require("./routes/userRoutes"),waliRoutes=require("./routes/waliRoutes"),feedRoutes=require("./routes/feedRoutes"),monthlyUsageRoutes=require("./routes/monthlyUsageRoutes"),dashboardRoutes=require("./routes/dashboard"),getstreamVideoCallRoutes=require("./routes/getstreamVideoCallRoutes"),videoCallTimeRoutes=require("./routes/videoCallTime"),cors=require("cors"),mongoose=require("mongoose"),User=require("./models/User"),VideoCallTime=require("./models/VideoCallTime"),compression=require("compression"),{trackRequestPerformance:trackRequestPerformance,performanceEndpoint:performanceEndpoint,healthCheckEndpoint:healthCheckEndpoint}=require("./middlewares/performanceMonitor"),{createIndexes:createIndexes}=require("./config/indexes"),{startScheduler:startScheduler}=require("./utils/emailScheduler");dotenv.config(),connectDB();const app=express(),server=http.createServer(app),corsOptions={origin:["http://localhost:8080","http://localhost:5173","http://localhost:3000","https://quluub-reborn-project-33.vercel.app","https://preview--quluub-reborn-project-99.lovable.app","https://love.quluub.com","https://match.quluub.com"],methods:["GET","HEAD","PUT","PATCH","POST","DELETE","OPTIONS"],allowedHeaders:["Content-Type","Authorization","X-Requested-With","Accept","Origin"],credentials:!0,optionsSuccessStatus:200,preflightContinue:!1};app.use(cors(corsOptions)),app.options("*",cors(corsOptions)),app.use(compression({level:6})),app.use(express.json());const io=new Server(server,{path:"/socket.io/",cors:{origin:["http://localhost:8080","http://localhost:5173","http://localhost:3000","https://quluub-reborn-project-33.vercel.app","https://preview--quluub-reborn-project-99.lovable.app","https://love.quluub.com","https://match.quluub.com"],methods:["GET","POST"],credentials:!0},transports:["websocket","polling"],allowEIO3:!0,pingTimeout:6e4,pingInterval:25e3,upgradeTimeout:1e4,maxHttpBufferSize:1e6,connectTimeout:2e4,serveClient:!1,cookie:!1,allowRequest:(e,t)=>{console.log("ðŸ”— Socket.IO connection request from:",e.headers.origin),t(null,!0)}});let onlineUsers=new Map,sentWaliCallEmail=new Set;app.set("io",io),app.set("onlineUsers",onlineUsers),io.use(async(e,t)=>{try{const o=e.handshake.auth.token;if(console.log("ðŸ” Socket auth attempt:",e.id,"Token exists:",!!o),!o){const o=`debug-${e.id}`;return e.userId=o,e.user={_id:o,fname:`Debug-${e.id.slice(-4)}`},console.log("ðŸ” Debug user created:",o),t()}try{const s=jwt.verify(o,process.env.JWT_SECRET),i=await User.findById(s.id).select("-password");if(!i){console.log("âŒ User not found for token:",s.id);const o=`debug-${e.id}`;return e.userId=o,e.user={_id:o,fname:`Debug-${e.id.slice(-4)}`},t()}e.userId=i._id.toString(),e.user=i,console.log("âœ… User authenticated:",i._id,i.fname),t()}catch(o){console.log("âŒ JWT verification failed:",o.message);const s=`debug-${e.id}`;e.userId=s,e.user={_id:s,fname:`Debug-${e.id.slice(-4)}`},t()}}catch(o){console.error("âŒ Main namespace socket authentication error:",o.message);const s=`debug-${e.id}`;e.userId=s,e.user={_id:s,fname:`Debug-${e.id.slice(-4)}`},t()}}),io.on("connection",e=>{console.log("ðŸ”Œ New socket connection:",e.id,"User:",e.userId),console.log("ðŸ”Œ Current online users before join:",Array.from(onlineUsers.keys())),e.on("join",async t=>{const o=t.toString();e.join(o),onlineUsers.set(o,e.id);try{await User.findByIdAndUpdate(o,{lastSeen:new Date,isOnline:!0}),console.log("âœ… Database updated: User",o,"marked as online")}catch(e){console.error("âŒ Error updating user online status:",e)}console.log("ðŸ‘¤ User joined:",o,"Socket:",e.id),console.log("ðŸ‘¥ Active users after join:",Array.from(onlineUsers.keys())),console.log("ðŸ‘¥ Total online users:",onlineUsers.size);const s=Array.from(onlineUsers.keys());io.emit("getOnlineUsers",s),e.broadcast.emit("user-came-online",{userId:o,timestamp:(new Date).toISOString()})}),e.on("joinNotifications",t=>{e.join(`notifications_${t}`)}),e.on("user-online-status",async t=>{const{userId:o,isOnline:s}=t;if(!o)return;const i=o.toString();if(s&&!onlineUsers.has(i)){onlineUsers.set(i,e.id);try{await User.findByIdAndUpdate(i,{lastSeen:new Date,isOnline:!0}),console.log("âœ… Explicit online status update: User",i,"marked as online")}catch(e){console.error("âŒ Error in explicit online status update:",e)}const t=Array.from(onlineUsers.keys());io.emit("getOnlineUsers",t),e.broadcast.emit("user-came-online",{userId:i,timestamp:(new Date).toISOString()})}}),e.on("join_conversation",t=>{e.join(t)}),e.on("leave_conversation",t=>{e.leave(t)}),e.on("getstream-session-join",async e=>{try{const{sessionId:t,participantId:o,participantName:s,hostId:i}=e||{};if(!t||!i||!o)return;const n=onlineUsers.get(i?.toString()),r={sessionId:t,recipientId:o,recipientName:s};n&&io.to(n).emit("getstream_call_accepted",r),io.to(i?.toString()).emit("getstream_call_accepted",r);try{require("./models/Notification").deleteMany({type:"getstream_video_call_invitation","data.sessionId":t}).catch(()=>{})}catch{}}catch(e){console.warn("getstream-session-join handler error:",e?.message||e)}}),e.on("getstream-video-call-end",async e=>{try{const{sessionId:t,callerId:o,recipientId:s}=e||{};if(!t||!o||!s)return;const i=[o.toString(),s.toString()],n=new Set;i.forEach(e=>{const o=onlineUsers.get(e),s={sessionId:t};o&&!n.has(o)&&(io.to(o).emit("getstream_call_ended",s),n.add(o)),o||io.to(e).emit("getstream_call_ended",s)});try{require("./models/Notification").deleteMany({type:"getstream_video_call_invitation","data.sessionId":t}).catch(()=>{})}catch{}}catch(e){console.warn("getstream-video-call-end handler error:",e?.message||e)}}),e.on("getstream-video-call-reject",e=>{try{const{sessionId:t,callerId:o,recipientId:s}=e||{};if(!t||!o||!s)return;const i=onlineUsers.get(o.toString()),n={sessionId:t,recipientId:s};i&&io.to(i).emit("getstream_call_rejected",n),io.to(o.toString()).emit("getstream_call_rejected",n)}catch{}}),e.on("getstream-video-call-cancel",e=>{try{const{sessionId:t,recipientId:o}=e||{};if(!t||!o)return;const s=onlineUsers.get(o.toString()),i={sessionId:t};s&&io.to(s).emit("getstream_call_cancelled",i),io.to(o.toString()).emit("getstream_call_cancelled",i)}catch{}}),e.on("disconnect",()=>{const t=[...onlineUsers.entries()].find(([t,o])=>o===e.id)?.[0];t&&(onlineUsers.delete(t),io.emit("getOnlineUsers",Array.from(onlineUsers.keys())))}),e.on("getstream-session-join",async e=>{const{sessionId:t,participantId:o,participantName:s,hostId:i,joinTimestamp:n,sessionType:r}=e;console.log("ðŸŽ¬ GetStream professional session join:",{sessionId:t,participantId:o,participantName:s,hostId:i,sessionType:r});const a=onlineUsers.get(i?.toString());a&&(io.to(a).emit("getstream_session_participant_joined",{sessionId:t,participantId:o,participantName:s,joinTimestamp:n,sessionType:r,message:`${s} joined the professional session`}),console.log(`âœ¨ Session join notification sent to host: ${i}`)),io.to(i?.toString()).emit("getstream_session_participant_joined",{sessionId:t,participantId:o,participantName:s,joinTimestamp:n,sessionType:r});try{const e=require("./models/Notification");await e.deleteMany({type:"getstream_video_session_invitation","data.sessionId":t}),console.log("âœ… GetStream session notifications cleared for session:",t)}catch(e){console.error("âŒ Error clearing GetStream session notifications:",e)}}),e.on("getstream-video-call-invitation",async e=>{const{recipientId:t,sessionId:o,callerId:s,callerName:i,callId:n}=e;console.log("ðŸ“ž GetStream video call invitation:",{recipientId:t,sessionId:o,callerId:s,callerName:i,callId:n});try{const e=require("./models/VideoCallTime");if(!(await e.getOrCreatePairRecord(s,t)).canMakeVideoCall()){const e=onlineUsers.get(s?.toString()),i={sessionId:o,recipientId:t,reason:"limit_exceeded",timestamp:(new Date).toISOString()};return e&&io.to(e).emit("getstream_call_rejected",i),void io.to(s?.toString()).emit("getstream_call_rejected",i)}}catch(e){console.warn("VideoCallTime check failed in invitation handler:",e?.message||e)}const r=onlineUsers.get(t?.toString());r&&(io.to(r).emit("getstream_video_call_invitation",{callerId:s,callerName:i,sessionId:o,callId:n,timestamp:(new Date).toISOString()}),console.log("âœ… GetStream invitation sent to recipient socket:",r)),io.to(t?.toString()).emit("getstream_video_call_invitation",{callerId:s,callerName:i,sessionId:o,callId:n,timestamp:(new Date).toISOString()}),console.log("âœ… GetStream invitation sent to recipient room:",t)}),e.on("getstream-video-call-accept",async e=>{const{sessionId:t,callerId:o,recipientId:s,callId:i}=e;console.log("âœ… GetStream video call accepted:",{sessionId:t,callerId:o,recipientId:s,callId:i});const n=onlineUsers.get(o?.toString());n&&(io.to(n).emit("getstream_call_accepted",{sessionId:t,recipientId:s,callId:i,timestamp:(new Date).toISOString()}),console.log("âœ… GetStream acceptance sent to caller socket:",n)),io.to(o?.toString()).emit("getstream_call_accepted",{sessionId:t,recipientId:s,callId:i,timestamp:(new Date).toISOString()}),console.log("âœ… GetStream acceptance sent to caller room:",o)}),e.on("getstream-video-call-reject",async e=>{const{sessionId:t,callerId:o,recipientId:s,reason:i}=e;console.log("âŒ GetStream video call rejected:",{sessionId:t,callerId:o,recipientId:s,reason:i});const n=onlineUsers.get(o?.toString());n&&(io.to(n).emit("getstream_call_rejected",{sessionId:t,recipientId:s,reason:i||"declined",timestamp:(new Date).toISOString()}),console.log("âœ… GetStream rejection sent to caller socket:",n)),io.to(o?.toString()).emit("getstream_call_rejected",{sessionId:t,recipientId:s,reason:i||"declined",timestamp:(new Date).toISOString()}),console.log("âœ… GetStream rejection sent to caller room:",o);try{const e=require("./models/Notification");await e.deleteMany({type:"getstream_video_call_invitation","data.sessionId":t}),console.log("âœ… GetStream notifications cleared for session:",t)}catch(e){console.error("âŒ Error clearing GetStream notifications:",e)}}),e.on("getstream-video-call-end",async e=>{const{sessionId:t,callerId:o,recipientId:s,duration:i}=e;console.log("ðŸ“´ GetStream video call ended:",{sessionId:t,callerId:o,recipientId:s,duration:i});const n=onlineUsers.get(o?.toString()),r=onlineUsers.get(s?.toString()),a={sessionId:t,callerId:o,recipientId:s,duration:i,timestamp:(new Date).toISOString()};n&&io.to(n).emit("getstream_call_ended",a),r&&io.to(r).emit("getstream_call_ended",a),io.to(o?.toString()).emit("getstream_call_ended",a),io.to(s?.toString()).emit("getstream_call_ended",a),console.log("âœ… GetStream call end notifications sent to both participants");try{if(t&&!sentWaliCallEmail.has(t)){sentWaliCallEmail.add(t);const{sendEmail:e}=require("./utils/emailService"),i=require("./utils/emailTemplates/waliVideoCallParticipation"),[n,r]=await Promise.all([User.findById(o).select("fname lname gender waliDetails"),User.findById(s).select("fname lname gender waliDetails")]);if(n||r){const o=r&&"female"===r.gender?r:n&&"female"===n.gender?n:null,s=o&&n&&o._id.toString()===n._id.toString()?r:n;if(o){let n="",r="";try{if(o.waliDetails){const e=JSON.parse(o.waliDetails);n=e?.email||e?.waliEmail||e?.wali_email||e?.guardianEmail||e?.parentEmail||e?.emailAddress||"",r=e?.name||e?.fullName||e?.waliName||""}}catch(e){console.warn("âš ï¸ Failed to parse waliDetails JSON for user:",o._id?.toString())}if(n){const a=(r||"").trim().split(" ")[0]||"Guardian",l=`${o.fname||""} ${o.lname||""}`.trim(),c=s?`${s.fname||""} ${s.lname||""}`.trim():"A member";try{const o="false"!==process.env.WALI_VIDEO_EMAILS_ENABLED,s=(process.env.WALI_VIDEO_EMAILS_BLOCKLIST||"").split(",").map(e=>e.trim().toLowerCase()).filter(Boolean).includes(n.toLowerCase());o?s?console.log(`âœ‹ Suppressing Wali participation email for blocklisted address: ${n}`):(await e({...i(a,l,c,"mailto:support@quluub.com"),to:n}),console.log("âœ… Wali participation email sent for session:",t,"to:",n)):console.log("âœ‹ Wali participation emails disabled via WALI_VIDEO_EMAILS_ENABLED=false")}catch(e){console.error("âŒ Failed to send Wali participation email:",e?.message||e)}}}}}}catch(e){console.error("âŒ Error while preparing/sending Wali participation email:",e?.message||e)}try{const e=require("./models/Notification");await e.deleteMany({type:"getstream_video_call_invitation","data.sessionId":t}),console.log("âœ… GetStream notifications cleared for session:",t)}catch(e){console.error("âŒ Error clearing GetStream notifications:",e)}}),e.on("getstream-video-call-cancel",async e=>{const{sessionId:t,callerId:o,recipientId:s}=e;console.log("ðŸš« GetStream video call cancelled:",{sessionId:t,callerId:o,recipientId:s});const i=onlineUsers.get(s?.toString());i&&(io.to(i).emit("getstream_call_cancelled",{sessionId:t,callerId:o,timestamp:(new Date).toISOString()}),console.log("âœ… GetStream cancellation sent to recipient socket:",i)),io.to(s?.toString()).emit("getstream_call_cancelled",{sessionId:t,callerId:o,timestamp:(new Date).toISOString()}),console.log("âœ… GetStream cancellation sent to recipient room:",s);try{const e=require("./models/Notification");await e.deleteMany({type:"getstream_video_call_invitation","data.sessionId":t}),console.log("âœ… GetStream notifications cleared for session:",t)}catch(e){console.error("âŒ Error clearing GetStream notifications:",e)}})}),app.get("/",(e,t)=>{t.send("API is running...")}),app.get("/health",healthCheckEndpoint),app.get("/api/performance",performanceEndpoint),app.use("/api/admin",adminRoutes),app.use("/api/auth",authRoutes),app.use("/api/chats",chatRoutes),app.use("/api/email",emailRoutes),app.use("/api/admin/match-notifications",matchNotificationRoutes),app.use("/api/notifications",notificationRoutes),app.use("/api/payments",paymentRoutes),app.use("/api/referrals",referralRoutes),app.use("/api/relationships",relationshipRoutes),app.use("/api/reports",reportRoutes),app.use("/api/users",userRoutes),app.use("/api/wali",waliRoutes),app.use("/api/feed",feedRoutes),app.use("/api/monthly-usage",monthlyUsageRoutes),app.use("/api/dashboard",dashboardRoutes),app.use("/api/getstream-video-call",getstreamVideoCallRoutes),app.use("/api/video-call-time",videoCallTimeRoutes);const{protect:protect}=require("./middlewares/authMiddleware");app.post("/api/user/set-online",protect,async(e,t)=>{try{const o=e.user.id,s=require("./models/User");await s.findByIdAndUpdate(o,{lastSeen:new Date,isOnline:!0}),onlineUsers.set(o,"api-connection"),io.emit("getOnlineUsers",Array.from(onlineUsers.keys())),t.json({success:!0,message:"User marked as online"})}catch(e){console.error("Error setting user online:",e),t.status(500).json({error:"Failed to set user online"})}}),app.get("/api/users/online",async(e,t)=>{try{const e=require("./models/User"),o=new Date(Date.now()-3e5),s=await e.find({lastSeen:{$gte:o}}).select("_id fname lname username lastSeen isOnline"),i=Array.from(onlineUsers.keys()),n=s.map(e=>e._id.toString()),r=[...new Set([...i,...n])];t.json({totalOnline:r.length,onlineUsers:r,recentlyActive:s,socketConnected:i})}catch(e){console.error("Error getting online users:",e),t.status(500).json({error:"Failed to get online users"})}}),app.get("/api/debug/online-users",async(e,t)=>{console.log("ðŸ” DEBUG ENDPOINT CALLED - Current state:"),console.log("ðŸ“Š Online users map:",Array.from(onlineUsers.entries()));let o=[];try{const e=new Date(Date.now()-3e5),t=await User.find({lastSeen:{$gte:e}}).select("_id fname lname username lastSeen isOnline");o=t,console.log("ðŸ’¾ Recently active users from DB:",t.map(e=>({id:e._id,name:`${e.fname} ${e.lname}`,lastSeen:e.lastSeen})))}catch(e){console.error("âŒ Error fetching recently active users:",e)}const s=Array.from(io.sockets.adapter.rooms.keys()).filter(e=>!e.startsWith("notifications_"));console.log("ðŸ  Main namespace rooms:",s),t.json({onlineUsers:Array.from(onlineUsers.keys()),onlineUsersCount:onlineUsers.size,onlineUsersMap:Object.fromEntries(onlineUsers),recentlyActiveUsers:o.map(e=>({id:e._id,name:`${e.fname} ${e.lname}`,username:e.username,lastSeen:e.lastSeen,isOnline:e.isOnline})),mainRooms:s,timestamp:(new Date).toISOString()})}),app.get("/api/debug/broadcast-online-users",(e,t)=>{io.emit("getOnlineUsers",onlineUsersList),t.json({message:"Broadcasted online users",totalOnline:onlineUsers.size,onlineUsers:onlineUsersList})}),app.use(notFound),app.use(errorHandler);const PORT=process.env.PORT||5e3;io.engine.on("connection_error",e=>{console.error("âŒ Socket.IO connection error:",e.req),console.error("âŒ Error code:",e.code),console.error("âŒ Error message:",e.message),console.error("âŒ Error context:",e.context)}),server.listen(PORT,async()=>{startScheduler(),mongoose.connection.once("connected",async()=>{setTimeout(async()=>{await createIndexes()},1e3)})});